# Applying Architecture


MVCとDDDの設計思想を取り入れたい

そのための奮闘記

## ドメイン・レイヤーを当てはめる

考えのまとめ


#### ユーザの操作

起こりえるユーザ操作と、拡張機能に関わりそうな部分

@popup

- popupを開く
- popup上のRUNボタンを押す

@Udemy-page

- ブラウザのサイズを変更する
- 字幕を変更する
- トランスクリプトをON/OFFにする
- URLが変わる(動画が切り替わる)
- tabを閉じる（ブラウザを閉じる）

- ExTranscriptを閉じる


#### 一般的な処理の流れ

ユーザの操作

リスナの反応

メッセージ・パッシングでbackground(アプリケーション・レイヤ)へ信号送信

backgroundで信号受信

backgroundで信号に応じて必要な処理単位をキューに詰める

キューを実行する

処理単位の成功で状態更新

処理単位の失敗でエラー送信、または呼び出し元へもどって表示、キューを空にする

すべての処理単位の成功でキューが空になる

~キューが空になったら必要に応じて信号送信元へ処理結果を返す~

(アプリケーションがなにをビジネスロジックにかかわっているので処理結果を返すのは
ドメイン層の指示に依る)

#### タスク管理のStateとビジネスロジック管理のStateを区別すること

microsoftのDDDの説明によれば
アプリケーション層が、タスク管理のための状態保持をしてもいいらしい

しかし
ビジネスロジックの管理はドメイン層の仕事なので、アプリケーション層から独立していないといかん

#### 単一責任の原則を守ること

責任とは：正常動作に対して責任を持つこと

正常動作に責任を持つクラスの設計方法

> オブジェクト指向におけるクラスは、
> - インスタンス変数
> - インスタンス変数 を正常に制御するメソッド
> から構成されるのが基本です

つまり単一責任とはある変数を変更できるクラスは一つだけで
そのクラスが負う責任は変数の正常動作にたいして責任を負うのである

その変数はビジネスロジック上必要不可欠で
その変数が仕様に反しない値をもつように管理されないといけない


例：popupでRUNを押したら

ユーザ操作：popupでRUNを押した

popup: backgroundへRUNが押された信号を送信

background: chrome.runtime.onMessageで受信

background: 信号内容を振り分け信号ごとのハンドラへ処理を移す

background: その信号に対するハンドラ内部でキューを生成する(必要な処理単位をキューにプッシュする)

    queue中身は以下の通り(今のところ思いつき)
    - URLは正しいか確認
    - contentScriptのinject: ビジネスロジック状態を更新
    - contentScriptからのステータス送信要請
    - contentScriptからのステータス内容確認: ビジネスロジック状態を更新
    - captureSubtitlesのinject：ビジネスロジック状態を更新
    - captureSubtitlesへ字幕データ送信要請
    - captureSubtitlesからの字幕データ内容確認：ビジネスロジック状態を更新
    - controllerのinject：ビジネスロジック状態を更新
    - controllerへExTranscriptの正常展開ができたのか確認要請
    - controllerからの状況送信確認：ビジネスロジック状態を更新

NOTE: 思い付きだけれど、各ビジネスロジックの状態変化をnotifyされるようオブザーバをつけるといいことあるのかな？
    queueuのタスクが空になったらqueueの正常終了
    途中でエラーまたは中断の理由が発生したらqueueの異常終了

background: キューの中身を実行させる

NOTE: RUNにおけるタスクの詳細を詰めればほぼアプリの構成が定まるのでは？



#### State更新の流れ

処理単位という名の関数 task関数と呼ぶ

task関数 --> Stateの更新指示 --> State管理クラス --> chrome.storage.localの管理クラス --> sotrage更新完了

State更新指示、State管理クラスはドメイン(model)の仕事
chrome.storage.localの管理クラスはインフラストラクチャ層の仕事

ドメイン層の指示に従ってStateを更新して
storage.localへ保存する


#### ビジネスロジック

